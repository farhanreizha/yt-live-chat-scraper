<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Live Chat Viewer</title>

    <!-- CSS Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- Custom Styles -->
    <style>
      body {
        font-size: 14px;
      }

      /* Animations */
      .chat-message {
        animation: slideIn 0.3s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Membership Styling */
      .membership-message {
        padding-left: 0.5rem;
        padding-top: 0.25rem;
        padding-bottom: 0.25rem;
      }

      /* Badge Components */
      .leaderboard {
        padding: 0.15rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.7rem;
        font-weight: bold;
        line-height: 1;
        text-transform: uppercase;
      }

      .membership-badge {
        font-size: 0.6rem;
        margin-left: 0.2rem;
        opacity: 0.9;
        font-weight: bold;
      }

      .superchat-amount {
        font-size: 0.75rem;
        /* color: #e74c3c; */
        font-weight: 700;
      }

      .gradient-border {
        position: relative;
        background: linear-gradient(white, white) padding-box;
        /* linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1) border-box; */
        background-size: 200% 200%;
      }

      .gradient-border:before,
      .gradient-border:after {
        content: '';
        position: absolute;
        left: -2px;
        top: -2px;
        background: linear-gradient(135deg, #ff6b6b, #4ecdc4, #45b7d1);
        background-size: 400%;
        width: calc(100% + 4px);
        height: calc(100% + 4px);
        border-radius: 0.5rem;
        z-index: -1;
        animation: steam 20s linear infinite;
      }
      @keyframes steam {
        0% {
          background-position: 0 0;
        }
        50% {
          background-position: 400% 0;
        }
        100% {
          background-position: 0 0;
        }
      }
      .gradient-border:after {
        filter: blur(50px);
      }

      /* Scrollbar Styling */
      .chat-container::-webkit-scrollbar {
        width: 6px;
      }
      .chat-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
      }
      .chat-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
      }
    </style>
  </head>

  <body class="w-full h-screen overflow-hidden flex flex-col">
    <!-- Chat Messages Container -->
    <div class="chat-container flex-1 overflow-y-auto p-3 space-y-3">
      <!-- Sample Chat Messages -->
      <div class="chat-message flex items-start space-x-2 text-black hidden">
        <img
          src="https://i.pravatar.cc/40?img=1"
          alt="User"
          class="w-8 h-8 rounded-full hidden avatar"
        />
        <div
          class="message-container bg-gray-800/80 rounded-lg p-3 text-white shadow-lg shadow-gray-800/50 max-w-screen w-full"
        >
          <div class="flex items-center author space-x-2">
            <span class="author-name font-semibold text-gray-100"></span>
            <span class="badge-container hidden space-x-2"></span>
            <span class="leaderboard hidden"></span>
          </div>
          <p class="text-sm mt-1 message-text"></p>
        </div>
      </div>

      <!-- Superchat Chat Messages -->
      <!-- <div class="super-chat flex items-start space-x-2 text-black hidden">
        <img
          src="https://i.pravatar.cc/40?img=1"
          alt="User"
          class="w-8 h-8 rounded-full hidden avatar"
        />
        <div
          class="super-chat-container bg-gray-800/80 rounded-lg p-3 text-white shadow-lg shadow-gray-800/50 max-w-screen w-full"
        >
          <div class="flex items-center author space-x-2">
            <span class="author-name font-semibold text-gray-100"></span>
            <span class="badge-container hidden space-x-2"></span>
            <span class="leaderboard"></span>
          </div>
          <p class="text-sm mt-1 super-chat-text"></p>
        </div>
      </div> -->
    </div>

    <!-- Application Script -->
    <script>
      // Configuration
      const CONFIG = {
        videoId: 'putrirp', // !change this
        // videoId: 'TheJooomers',
        maxMessages: 50,
        serverUrl: 'ws://localhost:3000',
      };

      // WebSocket connection
      const socket = new WebSocket(`${CONFIG.serverUrl}/live/${CONFIG.videoId}`);

      // Utility functions
      const Utils = {
        sanitizeText: (text) => text?.replace(/`/g, '').trim() || '',

        createElement: (tag, className, textContent) => {
          const element = document.createElement(tag);
          if (className) element.className = className;
          if (textContent) element.textContent = textContent;
          return element;
        },

        replaceEmojis: (text, emojis) => {
          if (!emojis?.length) return text;

          return emojis.reduce((html, emoji) => {
            if (!emoji.text || !emoji.url) return html;

            const text = Utils.sanitizeText(emoji.text);
            const url = Utils.sanitizeText(emoji.url);
            const escapedText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');

            return html.replace(
              new RegExp(escapedText, 'g'),
              `<img src="${url}" alt="${text}" class="inline-block h-5 w-5 align-text-bottom">`,
            );
          }, text);
        },
      };

      // Badge handler
      const BadgeHandler = {
        createBadge: (type, iconClass) => {
          const badge = Utils.createElement('span', `text-${type}-500`);
          badge.innerHTML = `<i class="${iconClass}"></i>`;
          return badge;
        },

        processBadges: (author) => {
          if (!author?.badges?.length) return [];

          const badgeTypes = {
            moderator: { icon: 'fa-solid fa-wrench', color: 'blue' },
            member: { icon: '', color: 'green' },
            verified: { icon: 'fa-regular fa-circle-check', color: 'gray' },
          };

          return author.badges
            .map((badge) => {
              const config = badgeTypes[badge.type];
              if (!config) return null;

              const element = Utils.createElement('span');
              if (badge.url) {
                element.innerHTML = `<img src="${Utils.sanitizeText(
                  badge.url,
                )}" alt="${Utils.sanitizeText(badge.text)}" class="inline-block">`;
                element.className = 'p-0 bg-transparent';
              } else {
                element.textContent = Utils.sanitizeText(badge.text);
                if (badge.type === 'moderator') {
                  element.innerHTML = '<i class="fa-solid fa-wrench"></i>';
                  element.className = 'text-blue-500';
                } else if (badge.type === 'verified') {
                  element.innerHTML = '<i class="fa-regular fa-circle-check"></i>';
                }
              }
              return element;
            })
            .filter(Boolean);
        },
      };

      // Message renderer
      const MessageRenderer = {
        renderMessage: (msg) => {
          const template = document.querySelector('.chat-message');
          if (!template) {
            console.error('Message template not found');
            return null;
          }

          const messageEl = template.cloneNode(true);
          messageEl.classList.remove('hidden');

          // Extract elements
          const authorName = messageEl.querySelector('.author-name');
          const messageText = messageEl.querySelector('.message-text');
          const badgeContainer = messageEl.querySelector('.badge-container');
          const avatar = messageEl.querySelector('.avatar');
          const leaderboard = messageEl.querySelector('.leaderboard');

          // Render components
          MessageRenderer.renderAuthor(authorName, msg.author);
          MessageRenderer.renderAvatar(avatar, msg.author);
          MessageRenderer.renderBadges(badgeContainer, msg.author);
          MessageRenderer.renderMembershipBadges(badgeContainer, msg.message);
          MessageRenderer.renderMessageContent(messageText, msg.message);
          MessageRenderer.renderLeaderboard(leaderboard, msg.leaderboard);
          MessageRenderer.renderMembershipStyling(messageText, msg.message);
          MessageRenderer.renderSuperChatMessage(messageText, msg.message);

          return messageEl;
        },

        renderAuthor: (element, author) => {
          if (!element || !author) return;

          element.textContent = Utils.sanitizeText(author.name);

          const colors = {
            owner: 'text-yellow-500',
            moderator: 'text-blue-500',
            member: 'text-green-500',
          };

          const isOwner = author.isOwner;
          const isModerator = author.badges?.some((b) => b.type === 'moderator');
          const isMember = author.badges?.some((b) => b.type === 'member');

          if (isOwner) element.className = `author-name font-semibold ${colors.owner}`;
          else if (!isOwner && isModerator)
            element.className = `author-name font-semibold ${colors.moderator}`;
          else if (!isOwner && !isModerator && isMember)
            element.className = `author-name font-semibold ${colors.member}`;
          else element.className = 'author-name font-semibold text-gray-100';
        },

        renderAvatar: (element, author) => {
          if (!element || !author?.photo) return;

          element.src = Utils.sanitizeText(author.photo);
          element.classList.remove('hidden');
        },

        renderBadges: (element, author) => {
          if (!element || !author?.badges?.length) {
            element?.classList.add('hidden');
            return;
          }

          element.innerHTML = '';
          element.classList.remove('hidden');

          const badges = BadgeHandler.processBadges(author);
          badges.forEach((badge) => element.appendChild(badge));
        },

        renderMessageContent: (element, message) => {
          if (!element || !message) return;

          let content = Utils.sanitizeText(message.text);
          content = Utils.replaceEmojis(content, message.emojis);
          element.innerHTML = content;
        },

        renderLeaderboard: (element, rank) => {
          console.log('[DEBUG]: Leaderboard', rank);
          if (!element || !rank) {
            element?.classList.add('hidden');
            return;
          }

          element.innerHTML = `<i class="fa-solid fa-crown"></i> ${Utils.sanitizeText(rank)}`;
          element.classList.remove('hidden');
          element.classList.add('bg-purple-600', 'text-white', 'font-bold');
        },

        renderMembershipBadges: (badgeContainer, message) => {
          if (!badgeContainer || !message?.isMessageMembership) return;

          if (message.membershipStatus) {
            const status = Utils.createElement(
              'span',
              'bg-purple-600/50 border-l-4 border-solid border-purple-600 text-white text-xs px-2 py-1 rounded-md font-bold text-black',
              message.membershipStatus,
            );
            badgeContainer.appendChild(status);
          }

          if (message.membershipTier) {
            const tier = Utils.createElement(
              'span',
              'bg-green-600/50 border-l-4 border-solid border-green-600 text-white text-xs px-2 py-1 rounded-md font-bold text-black',
              message.membershipTier,
            );
            badgeContainer.appendChild(tier);
          }
        },

        renderMembershipStyling: (element, message) => {
          element.classList.add('membership-message');

          const container = element.parentElement;
          if (!container) return;

          if (!message?.isMessageMembership || !element) {
            container.classList.add('bg-gray-800/80', 'shadow-gray-800/50', 'text-white');
            container.classList.remove(
              'border-l-4',
              'border-solid',
              'border-green-500',
              'bg-green-500/20',
              'shadow-green-500/50',
            );
            return;
          }

          container.classList.remove('bg-gray-800/80', 'shadow-gray-800/50', 'text-white');
          container.classList.add(
            'border-l-4',
            'border-solid',
            'border-green-500',
            'bg-green-500/20',
            'shadow-green-500/50',
          );
        },

        renderSuperChatMessage: (element, message) => {
          const container = element.parentElement;
          if (!container) return;

          if (!message?.isMessageSuperchat || !element) {
            container.classList.add('bg-gray-800/80', 'shadow-gray-800/50', 'text-white');
            container.classList.remove(
              'gradient-border',
              'bg-linear-to-r/hsl',
              'from-indigo-500',
              'to-teal-400',
            );
            return;
          }

          if (container.classList) {
            container.classList.remove('bg-gray-800/80', 'shadow-gray-800/50', 'text-white');
            container.classList.add(
              'gradient-border',
              'bg-linear-to-r/hsl',
              'from-indigo-500',
              'to-teal-400',
            );
          }
        },
      };

      // Chat management
      const ChatManager = {
        container: document.querySelector('.chat-container'),

        addMessages: (messages) => {
          if (!ChatManager.container) return;

          messages.forEach((msg) => {
            console.log(msg);
            const renderedMessage = MessageRenderer.renderMessage(msg);
            if (renderedMessage) {
              ChatManager.container.appendChild(renderedMessage);
            }
          });

          ChatManager.scrollToBottom();
          ChatManager.limitMessages();
        },

        scrollToBottom: () => {
          if (ChatManager.container) {
            ChatManager.container.scrollTop = ChatManager.container.scrollHeight;
          }
        },

        limitMessages: () => {
          if (!ChatManager.container) return;

          while (ChatManager.container.children.length > CONFIG.maxMessages) {
            ChatManager.container.removeChild(ChatManager.container.children[0]);
          }
        },

        handleDisconnect: () => {
          const chatList = document.getElementById('chat');
          if (chatList) chatList.innerHTML = '<li>Live ended</li>';
        },
      };

      // Event handlers
      socket.onopen = () => console.log('Connected to server');

      socket.onmessage = (event) => {
        const messagesData = JSON.parse(event.data);
        ChatManager.addMessages(messagesData);
      };

      socket.onclose = () => {
        console.log('Disconnected');
        ChatManager.handleDisconnect();
      };
    </script>
  </body>
</html>
